# ===== 定位通用参数 =====

# 是否使用外部车辆状态（而非内部估计）
use_external_carstate: false

# ROS话题配置
topics:
  ins: "sensors/ins"                           # INS惯导数据输入
  car_state_in: "localization/car_state"       # 车辆状态输入
  cone: "perception/lidar_cluster/detections"  # 锥桶检测结果输入
  car_state_out: "localization/car_state"      # 车辆状态输出
  cone_map: "localization/cone_map"            # 锥桶地图输出
  global_map: "localization/global_map"        # 全局地图输出
  pose: "localization/pose"                    # 位姿输出
  odom: "localization/odom"                    # 里程计输出

# 坐标系配置
frames:
  world: "world"                     # 世界坐标系
  base_link: "base_link"             # 车体坐标系

# 传感器安装距离参数
length:
  lidarToIMUDist: 1.87               # 激光雷达到IMU的距离 (m)
  frontToIMUdistanceX: 0.0           # 前轴到IMU的X方向距离 (m)
  frontToIMUdistanceY: 0.0           # 前轴到IMU的Y方向距离 (m)
  frontToIMUdistanceZ: 0.0           # 前轴到IMU的Z方向距离 (m)
  rearToIMUdistanceX: 0.0            # 后轴到IMU的X方向距离 (m)
  rearToIMUdistanceY: 0.0            # 后轴到IMU的Y方向距离 (m)
  rearToIMUdistanceZ: 0.0            # 后轴到IMU的Z方向距离 (m)

# 后端选择："mapper"（默认）或 "factor_graph"（影子模式）
backend: mapper

# INS信号质量过滤
ins_quality:
  min_ins_status: 2                  # 最低INS状态等级
  min_satellite_count: 8             # 最少卫星数量
  max_diff_age: 30                   # 最大差分龄期，单位 0.1s（30 = 3.0 秒）

# 因子图参数（仅在 backend=factor_graph 时使用）
fg:
  keyframe_dist: 1.0                 # 关键帧距离阈值 (m)
  keyframe_yaw: 0.1                  # 关键帧航向变化阈值 (rad)
  keyframe_dt: 0.5                   # 关键帧时间阈值 (s)
  run_extra_update: false            # 是否执行额外的iSAM更新（更精确但更慢）
  sigma_imu_xy: 0.05                 # IMU位置噪声 (m/√s)
  sigma_imu_theta: 0.01              # IMU航向噪声 (rad/√s)
  sigma_gnss_good: 0.5              # GNSS噪声 - 良好质量 (m)
  sigma_gnss_medium: 2.0             # GNSS噪声 - 中等质量 (m)
  sigma_gnss_poor: 10.0              # GNSS噪声 - 较差质量 (m)
  min_cone_confidence: 0.15          # 锥桶最低置信度，仅保留可靠观测
  max_cone_factors_per_keyframe: 10  # 每关键帧最大锥桶因子数，防止图膨胀
  # 颜色不匹配惩罚（等待相机颜色分类可用后启用）
  color_mismatch_penalty: 0.0        # 颜色不匹配代价
  merge_distance: 2.0                # 路标合并距离 (m)

  # 颜色-拓扑软关联（等待相机颜色分类可用后启用）
  w_maha: 1.0                        # 马氏距离权重
  w_color: 0.0                       # 颜色权重（当前禁用）
  w_topo: 0.0                        # 拓扑权重（当前禁用）
  topo_penalty: 0.0                  # 拓扑惩罚
  neighbor_radius: 8.0               # 邻域搜索半径 (m)
  gate_threshold: 15.0               # 关联门限阈值

  # 八字绕环圆形几何参数（由 map_mode 覆盖）
  circle_radius: 15.25               # 圆弧半径 (m)
  circle_center1_x: 0.0              # 圆心1 X坐标 (m)
  circle_center1_y: -9.125           # 圆心1 Y坐标 (m)
  circle_center2_x: 0.0              # 圆心2 X坐标 (m)
  circle_center2_y: 9.125            # 圆心2 Y坐标 (m)
  circle_sigma: 1.0                  # 圆形约束噪声 (m)

  # 异常状态机参数
  anomaly:
    chi2_degrade: 15.0               # 卡方退化阈值
    chi2_recover: 5.0                # 卡方恢复阈值
    chi2_window: 10                  # 卡方滑动窗口大小
    match_ratio_lost: 0.3            # 匹配丢失比率阈值
    match_lost_duration: 2.0         # 匹配丢失持续时间 (s)
    no_cone_frames_max: 30           # 无锥桶最大帧数
    reloc_a_timeout: 3.0             # 重定位A阶段超时 (s)
    reloc_b_timeout: 5.0             # 重定位B阶段超时 (s)

  # 重定位参数
  reloc:
    submap_radius: 15.0              # 子地图半径 (m)
    n_sectors: 12                    # 描述子扇区数
    n_rings: 5                       # 描述子环数
    max_descriptors: 200             # 最大描述子数量
    top_k: 5                         # 候选匹配数
    ransac_max_iter: 100             # RANSAC最大迭代次数
    min_inliers: 4                   # 最少内点数
    n_particles: 200                 # 粒子数量
    particle_sigma_xy: 3.0           # 粒子位置噪声 (m)
    converge_sigma: 0.5              # 收敛判定标准差 (m)
    timeout: 5.0                     # 重定位超时 (s)

# ==========================
# GEOMETRY ROBUSTNESS ENHANCEMENT (非视觉模式锁定)
# ==========================
# Mode: NON-VISION / PURE GEOMETRY
# w_color locked to 0.0, color features disabled

# 非视觉模式强制配置
vision_mode:
  enabled: false                    # 视觉模式总开关（锁定为false）
  w_color_locked: 0.0              # 颜色权重锁定为0
  color_classification: NONE       # 颜色分类模式: NONE | CAMERA | FUSION
  
# 几何降级策略（当视觉不可用时）
geometry_fallback:
  enabled: true                     # 启用纯几何降级
  min_observations: 2               # 纯几何模式最小观测数
  use_geometric_features_only: true # 仅使用几何特征
  
# 堆叠锥去重增强（Stacked Cone Dedup）
stacked_cone_dedup:
  enabled: true                     # 启用堆叠锥去重
  z_height_threshold: 0.3           # Z轴高度差阈值 (m)
  xy_distance_threshold: 0.3        # XY平面距离阈值 (m)
  max_cones_per_cell: 1             # 每个栅格最大锥桶数
  cell_size: 0.5                    # 栅格大小 (m)
  multi_layer_check: true           # 多层检测（处理堆叠）
  confidence_decay: 0.8             # 堆叠锥置信度衰减系数

# 缺锥 Fallback（Missing Cone Fallback）
missing_cone_fallback:
  enabled: true                     # 启用缺锥补偿
  max_interpolation_distance: 8.0   # 最大插值距离 (m)
  expected_spacing: 5.0             # 预期锥桶间距 (m)
  min_confidence_for_interpolation: 0.15  # 插值最小置信度
  max_consecutive_missing: 3        # 最大连续缺失数
  use_track_direction: true         # 利用赛道方向预测
  history_frames: 5                 # 历史帧数用于预测
  
# 短路径抑制（Short Path Suppression）
short_path_suppression:
  enabled: true                     # 启用短路径抑制
  min_path_length: 3.0              # 最小有效路径长度 (m)
  min_cone_count: 3                 # 最小锥桶数量
  velocity_based_threshold: true    # 基于速度的阈值
  min_velocity_factor: 0.3          # 低速时的路径长度因子
  reject_single_cone_paths: true    # 拒绝单锥路径
  
# 回环稳定性增强（Loop Closure Stability）
loop_closure:
  stability:
    enabled: true                   # 启用回环稳定性检查
    min_loop_length: 15.0          # 最小回环长度 (m)
    consistency_check_frames: 10    # 一致性检查帧数
    max_position_drift: 2.0        # 最大位置漂移 (m)
    max_heading_drift: 0.3         # 最大航向漂移 (rad)
    use_geometric_verification: true # 使用几何验证
    min_inlier_ratio: 0.6          # 最小内点比率
    
  # 回环触发条件（保守策略）
  trigger:
    min_travel_distance: 20.0      # 最小行驶距离 (m)
    min_time_elapsed: 10.0         # 最小时间间隔 (s)
    confidence_threshold: 0.7      # 置信度阈值
    
  # 几何一致性检查
  geometric_check:
    check_relative_pose: true      # 检查相对位姿
    check_track_width: true        # 检查赛道宽度一致性
    max_width_variation: 0.5       # 最大宽度变化 (m)
    check_spacing_consistency: true # 检查间距一致性
    spacing_tolerance: 1.0         # 间距容差 (m)

# 几何特征增强（Geometry Feature Boost）
geometric_features:
  enabled: true                     # 启用几何特征增强
  # 距离自适应权重
  distance_weighting:
    near_distance: 5.0             # 近距离阈值 (m)
    far_distance: 30.0             # 远距离阈值 (m)
    near_weight: 1.5               # 近距离几何权重
    far_weight: 0.8                # 远距离几何权重
  
  # 角度特征
  angle_features:
    use_bearing: true              # 使用方位角
    use_elevation: false           # 不使用俯仰角（2D定位）
    bearing_weight: 1.0            # 方位角权重
    
  # 距离特征
  distance_features:
    use_euclidean: true            # 使用欧氏距离
    use_manhattan: false           # 不使用曼哈顿距离
    use_chebyshev: false           # 不使用切比雪夫距离

# 数据关联鲁棒性（Data Association Robustness）
data_association:
  # 多假设跟踪
  multi_hypothesis:
    enabled: true                  # 启用多假设
    max_hypotheses: 3              # 最大假设数
    hypothesis_decay: 0.9          # 假设衰减因子
    
  # 门控策略
  gating:
    method: adaptive               # 门控方法: fixed | adaptive | chi2
    base_threshold: 3.0            # 基础门限 (m)
    adaptive_factor: 1.5           # 自适应因子
    max_threshold: 8.0             # 最大门限 (m)
    
  # 最近邻改进
  nearest_neighbor:
    use_mahalanobis: true          # 使用马氏距离
    use_euclidean_fallback: true   # 欧氏距离回退
    outlier_rejection: true        # 离群点剔除
    outlier_threshold: 5.0         # 离群点阈值 (m)

