# ==========================================================
# Localization Common Config (定位通用配置文件)
# ==========================================================
# 加载顺序: 在 location.yaml 之前加载（可选）
# 作用: 提供全局共享的默认参数
# 注意: 此文件的参数会被 location.yaml 中的同名参数覆盖
#
# 【说明】
# 此文件包含更详细的参数，特别是因子图相关的配置
# 以及INS质量门控、几何鲁棒性增强等高级功能
# ==========================================================

# ==========================
# 车辆状态来源选择
# ==========================
use_external_carstate: false

# ==========================
# ROS Topics Configuration
# ==========================
topics:
  ins: "sensors/ins"
  car_state_in: "localization/car_state"
  cone: "perception/lidar_cluster/detections"
  car_state_out: "localization/car_state"
  cone_map: "localization/cone_map"
  global_map: "localization/global_map"
  pose: "localization/pose"
  odom: "localization/odom"

# ==========================
# 坐标系配置
# ==========================
frames:
  world: "world"
  base_link: "base_link"

# ==========================
# 传感器安装参数
# ==========================
length:
  lidarToIMUDist: 1.87
  frontToIMUdistanceX: 0.0
  frontToIMUdistanceY: 0.0
  frontToIMUdistanceZ: 0.0
  rearToIMUdistanceX: 0.0
  rearToIMUdistanceY: 0.0
  rearToIMUdistanceZ: 0.0

# ==========================
# 后端选择
# ==========================
backend: mapper

# ==========================
# mapper 运行态保护（仅 backend=mapper 生效）
# ==========================
# 目标：当锥桶匹配连续失败时，降级为 INS-only，避免坏观测污染地图；
#      在冷却后按探测帧尝试恢复，连续成功后回到 TRACKING。
mapper_recovery:
  enabled: true
  fail_frames_to_degraded: 3
  fail_frames_to_ins_only: 8
  success_frames_to_tracking: 3
  recovery_cooldown_frames: 20
  recovery_probe_interval_frames: 3
  min_local_cones_for_tracking: 3
  min_match_ratio_for_tracking: 0.25
  publish_stale_map_on_failure: true

# ==========================
# TF 时序监控
# ==========================
tf_monitor:
  max_delay_sec: 0.10        # 允许的最大发布滞后（now - stamp）
  max_future_sec: 0.02       # 允许的最大未来时间戳
  max_gap_sec: 0.20          # 相邻发布最大时间间隔

# ==========================
# heading/yaw 单位自检（INS度 -> ROS弧度）
# ==========================
heading_sanity:
  enabled: true
  abs_max_deg: 360.0
  max_step_deg: 45.0
  max_rate_deg_per_sec: 180.0
  max_heading_gyro_residual_rad_s: 0.35

# ==========================
# 第一圈建图后冻结策略
# ==========================
map:
  freeze:
    enabled: false
    freeze_after_frames: 300
    freeze_after_cones: 120
    allow_merge_when_frozen: true
    allow_new_cones_when_frozen: false

# ==========================
# 定位 debug topics
# ==========================
debug_topics:
  enabled: true
  inlier_map: "localization/debug/inlier_map"
  outlier_map: "localization/debug/outlier_map"
  local_map: "localization/debug/local_map"
  match_pairs: "localization/debug/match_pairs"
  relocalization: "localization/debug/relocalization"
  max_pairs: 20

# ==========================
# 地图漂移检测与回退
# ==========================
map_drift:
  enabled: true
  min_match_ratio: 0.15
  max_mean_match_distance: 2.0
  min_local_cones: 2
  bad_frames_to_trigger: 15
  cooldown_frames: 50
  trigger_only_when_frozen: true
  action: "rollback"   # rollback | reset | freeze

# ==========================
# 地图版本化保存/加载接口
# ==========================
map_persistence:
  enabled: true
  save_path: "/tmp/localization_map.csv"
  version_tag: "v1"
  save_service: "localization/map/save"
  load_service: "localization/map/load"

# ==========================
# INS信号质量门控
# ==========================
# 当INS数据质量不满足要求时的处理策略
ins_quality:
  # 最低INS状态等级
  # 影响：什么质量的INS数据才用于定位
  # 调大：更严格，只使用高质量数据（可能漏帧）
  # 调小：更宽松，使用更多数据（可能有噪声）
  min_ins_status: 2
  
  # 最少卫星数量
  # 影响：GNSS定位精度
  # 建议：>= 8颗卫星才能保证良好精度
  min_satellite_count: 8
  
  # 最大差分龄期
  # 单位：0.1秒（30 = 3.0秒）
  # 影响：差分校正数据的新鲜度
  # 调大：容忍更老的差分数据（可能精度下降）
  # 调小：要求更新鲜的差分数据（可能丢帧）
  max_diff_age: 30

# ==========================
# 因子图参数（实验性功能）
# ==========================
# ⚠️ 仅在 backend=factor_graph 时生效
# 当前作为影子模式运行，用于与mapper后端对比
fg:
  # 关键帧生成阈值
  keyframe_dist: 1.0                 # 距离阈值 (m)
  keyframe_yaw: 0.1                  # 航向变化阈值 (rad)
  keyframe_dt: 0.5                   # 时间阈值 (s)
  
  run_extra_update: false
  
  # 噪声模型
  sigma_imu_xy: 0.05
  sigma_imu_theta: 0.01
  sigma_gnss_good: 0.5
  sigma_gnss_medium: 2.0
  sigma_gnss_poor: 10.0
  
  # 锥桶观测
  min_cone_confidence: 0.15
  max_cone_factors_per_keyframe: 10
  
  # 数据关联
  color_mismatch_penalty: 0.0
  merge_distance: 2.0
  w_maha: 1.0
  w_color: 0.0
  w_topo: 0.0
  topo_penalty: 0.0
  neighbor_radius: 8.0
  gate_threshold: 15.0
  
  # 八字绕环圆形几何参数
  circle_radius: 15.25
  circle_center1_x: 0.0
  circle_center1_y: -9.125
  circle_center2_x: 0.0
  circle_center2_y: 9.125
  circle_sigma: 1.0
  
  # 异常状态机参数
  anomaly:
    chi2_degrade: 15.0               # 卡方退化阈值
    chi2_recover: 5.0                # 卡方恢复阈值
    chi2_window: 10                  # 卡方滑动窗口大小
    match_ratio_lost: 0.3            # 匹配丢失比率阈值
    match_lost_duration: 2.0         # 匹配丢失持续时间 (s)
    no_cone_frames_max: 30           # 无锥桶最大帧数
    reloc_a_timeout: 3.0             # 重定位A阶段超时 (s)
    reloc_b_timeout: 5.0             # 重定位B阶段超时 (s)
  
  # 重定位参数
  reloc:
    submap_radius: 15.0              # 子地图半径 (m)
    n_sectors: 12                    # 描述子扇区数
    n_rings: 5                       # 描述子环数
    max_descriptors: 200             # 最大描述子数量
    top_k: 5                         # 候选匹配数
    ransac_max_iter: 100             # RANSAC最大迭代次数
    min_inliers: 4                   # 最少内点数
    n_particles: 200                 # 粒子数量
    particle_sigma_xy: 3.0           # 粒子位置噪声 (m)
    converge_sigma: 0.5              # 收敛判定标准差 (m)
    timeout: 5.0                     # 重定位超时 (s)

# ==========================
# GEOMETRY ROBUSTNESS ENHANCEMENT
# 几何鲁棒性增强配置（非视觉模式）
# ==========================
# Mode: NON-VISION / PURE GEOMETRY
# w_color locked to 0.0, color features disabled

# 非视觉模式强制配置
vision_mode:
  enabled: false                    # 视觉模式总开关（锁定为false）
  w_color_locked: 0.0              # 颜色权重锁定为0
  color_classification: NONE       # 颜色分类模式

# 几何降级策略（当视觉不可用时）
geometry_fallback:
  enabled: true                     # 启用纯几何降级
  min_observations: 2               # 纯几何模式最小观测数
  use_geometric_features_only: true # 仅使用几何特征

# 堆叠锥去重增强
stacked_cone_dedup:
  enabled: true                     # 启用堆叠锥去重
  z_height_threshold: 0.3           # Z轴高度差阈值 (m)
  xy_distance_threshold: 0.3        # XY平面距离阈值 (m)
  max_cones_per_cell: 1             # 每个栅格最大锥桶数
  cell_size: 0.5                    # 栅格大小 (m)
  multi_layer_check: true           # 多层检测（处理堆叠）
  confidence_decay: 0.8             # 堆叠锥置信度衰减系数

# 缺锥 Fallback
missing_cone_fallback:
  enabled: true                     # 启用缺锥补偿
  max_interpolation_distance: 8.0   # 最大插值距离 (m)
  expected_spacing: 5.0             # 预期锥桶间距 (m)
  min_confidence_for_interpolation: 0.15  # 插值最小置信度
  max_consecutive_missing: 3        # 最大连续缺失数
  use_track_direction: true         # 利用赛道方向预测
  history_frames: 5                 # 历史帧数用于预测

# 短路径抑制
short_path_suppression:
  enabled: true                     # 启用短路径抑制
  min_path_length: 3.0              # 最小有效路径长度 (m)
  min_cone_count: 3                 # 最小锥桶数量
  velocity_based_threshold: true    # 基于速度的阈值
  min_velocity_factor: 0.3          # 低速时的路径长度因子
  reject_single_cone_paths: true    # 拒绝单锥路径

# 回环稳定性增强
loop_closure:
  stability:
    enabled: true                   # 启用回环稳定性检查
    min_loop_length: 15.0          # 最小回环长度 (m)
    consistency_check_frames: 10    # 一致性检查帧数
    max_position_drift: 2.0        # 最大位置漂移 (m)
    max_heading_drift: 0.3         # 最大航向漂移 (rad)
    use_geometric_verification: true # 使用几何验证
    min_inlier_ratio: 0.6          # 最小内点比率
  
  trigger:
    min_travel_distance: 20.0      # 最小行驶距离 (m)
    min_time_elapsed: 10.0         # 最小时间间隔 (s)
    confidence_threshold: 0.7      # 置信度阈值
  
  geometric_check:
    check_relative_pose: true      # 检查相对位姿
    check_track_width: true        # 检查赛道宽度一致性
    max_width_variation: 0.5       # 最大宽度变化 (m)
    check_spacing_consistency: true # 检查间距一致性
    spacing_tolerance: 1.0         # 间距容差 (m)

# 几何特征增强
geometric_features:
  enabled: true                     # 启用几何特征增强
  
  distance_weighting:
    near_distance: 5.0             # 近距离阈值 (m)
    far_distance: 30.0             # 远距离阈值 (m)
    near_weight: 1.5               # 近距离几何权重
    far_weight: 0.8                # 远距离几何权重
  
  angle_features:
    use_bearing: true              # 使用方位角
    use_elevation: false           # 不使用俯仰角（2D定位）
    bearing_weight: 1.0            # 方位角权重
  
  distance_features:
    use_euclidean: true            # 使用欧氏距离
    use_manhattan: false           # 不使用曼哈顿距离
    use_chebyshev: false           # 不使用切比雪夫距离

# 数据关联鲁棒性
data_association:
  multi_hypothesis:
    enabled: true                  # 启用多假设
    max_hypotheses: 3              # 最大假设数
    hypothesis_decay: 0.9          # 假设衰减因子
  
  gating:
    method: adaptive               # 门控方法: fixed | adaptive | chi2
    base_threshold: 3.0            # 基础门限 (m)
    adaptive_factor: 1.5           # 自适应因子
    max_threshold: 8.0             # 最大门限 (m)
  
  nearest_neighbor:
    use_mahalanobis: true          # 使用马氏距离
    use_euclidean_fallback: true   # 欧氏距离回退
    outlier_rejection: true        # 离群点剔除
    outlier_threshold: 5.0         # 离群点阈值 (m)

# ==========================
# 【调参说明】
# ==========================
#
# 本文件包含高级参数，一般情况下不需要修改
# 主要调整 location.yaml 和 location_<mode>.yaml 中的参数即可
#
# 如需启用 factor_graph 后端：
#   1. 设置 backend: factor_graph
#   2. 调整 fg/* 相关参数
#   3. 注意：当前为实验性功能，建议与mapper并行运行对比
#
# 如需调整几何鲁棒性：
#   - 修改 vision_mode/geometry_fallback 相关参数
#   - 这些参数在纯LiDAR模式下自动生效
