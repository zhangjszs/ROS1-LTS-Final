# ==========================================================
# State Estimator Config (状态估计器参数)
# ==========================================================
# 组件: state_estimator_node
# 作用: ESKF (Error State Kalman Filter) 状态估计
# 输入: IMU数据、GNSS位置、速度观测
# 输出: 平滑后的车辆状态（位置、速度、航向）
#
# 【使用场景】
#   1. 当 use_external_carstate=false 时，作为主定位源
#   2. 提供高频（100Hz+）状态估计
#   3. 融合IMU和GNSS观测
# ==========================================================

# ==========================
# 传感器使用开关
# ==========================
# 是否使用GNSS定位观测
# true:  使用GNSS位置作为观测
# false: 纯IMU积分（会漂移）
use_gnss: true

# 是否使用速度观测
# 来自INS的速度数据
use_velocity: true

# 是否使用航向角观测
# 来自INS的航向角
use_yaw: true

# ==========================
# IMU噪声参数
# ==========================
# ⚠️ 这些参数影响滤波收敛和估计精度
# 应与实际IMU特性匹配

# 加速度计噪声
# 单位: m/s² | 建议范围: 0.5-2.0
# 调大：更信任模型，滤波更平滑（延迟↑）
# 调小：更信任观测，响应更快（噪声↑）
accel_noise: 1.0

# 陀螺仪噪声
# 单位: rad/s | 建议范围: 0.01-0.1
# 调大：更信任模型，航向更平滑（漂移↑）
# 调小：更信任观测，航向响应快（抖动↑）
gyro_noise: 0.05

# 陀螺仪比例因子
# 用于校正陀螺仪刻度误差
gyro_scale: 1.0

# ==========================
# 观测噪声参数
# ==========================
# 这些参数影响对观测的信任程度

# 位置观测噪声
# 单位: m | 建议范围: 0.1-1.0
# 调大：更不信任GNSS位置（平滑但延迟）
# 调小：更信任GNSS位置（响应快但噪声敏感）
meas_pos_noise: 0.5

# 速度观测噪声
# 单位: m/s | 建议范围: 0.1-0.5
meas_vel_noise: 0.2

# 航向角观测噪声
# 单位: rad | 建议范围: 0.01-0.1
meas_yaw_noise: 0.05

# ==========================
# 初始方差
# ==========================
# 滤波器初始状态的置信度

# 初始位置方差
# 单位: m²
init_pos_var: 1.0

# 初始速度方差
# 单位: (m/s)²
init_vel_var: 1.0

# 初始航向角方差
# 单位: rad²
init_yaw_var: 0.1

# ==========================
# 时间步长限制
# ==========================
# 防止时间异常导致的滤波发散

# 最小时间步长
# 单位: s
# 防止高频重复计算
min_dt: 0.001

# 最大时间步长
# 单位: s
# 超过此值认为数据丢失或异常
max_dt: 0.1

# ==========================
# 重力加速度
# ==========================
# 当地重力加速度
# 单位: m/s²
# 可根据海拔调整：
#   - 海平面: 9.81
#   - 一般情况: 9.79
accel_gravity: 9.79

# ==========================
# FSSIM风格低速运动学修正
# ==========================
# 低速时动力学模型不稳定，使用运动学模型修正
kinematic_correction:
  # 启用低速运动学修正
  enable: true
  
  # 轴距
  # 单位: m
  # 车辆前后轴之间的距离
  wheelbase: 1.55
  
  # 重心到后轴距离
  # 单位: m
  cg_to_rear: 0.775
  
  # 混合速度阈值
  # 单位: m/s
  # 低于此速度使用运动学模型
  blend_speed: 1.5
  
  # 混合过渡范围
  # 单位: m/s
  # 在 blend_speed ~ blend_speed+blend_range 之间平滑过渡
  blend_range: 1.0
  
  # 速度区域说明:
  #   0 ~ 1.5 m/s:      纯运动学模型
  #   1.5 ~ 2.5 m/s:    运动学↔动力学混合
  #   > 2.5 m/s:        纯动力学模型

# ==========================
# ROS Topics Configuration
# ==========================
topics:
  # INS数据输入
  # 消息类型: autodrive_msgs/HUAT_InsP2
  ins: "sensors/ins"
  
  # 车辆状态输出
  # 消息类型: autodrive_msgs/HUAT_CarState
  car_state: "localization/car_state"

# ==========================
# 【调参指南】
# ==========================
#
# 1. 如位置估计抖动大：
#    - 增大 meas_pos_noise (0.5→1.0)
#    - 增大 accel_noise (1.0→1.5)
#
# 2. 如位置估计延迟大：
#    - 减小 meas_pos_noise (0.5→0.3)
#    - 减小 accel_noise (1.0→0.8)
#
# 3. 如航向估计漂移：
#    - 检查 gyro_scale 是否正确标定
#    - 减小 gyro_noise (0.05→0.03)
#    - 确保 use_yaw = true
#
# 4. 如低速时状态异常：
#    - 启用 kinematic_correction/enable
#    - 调整 blend_speed (1.5→2.0)
#    - 检查 wheelbase 和 cg_to_rear 是否准确
#
# 5. 如滤波发散：
#    - 检查 max_dt 是否合理
#    - 增大 init_pos_var (1.0→5.0) 给初始状态更大不确定性
#    - 检查传感器数据是否正常
#
# 【观测命令】
#   rostopic echo /localization/car_state | grep -E "(x|y|vx|vy|yaw)"
#   rostopic hz /localization/car_state
