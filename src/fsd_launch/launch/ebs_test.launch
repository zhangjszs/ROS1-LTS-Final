<!--
  FSD EBS Test Mission - Emergency Brake System 接口预留

  用法:
    roslaunch fsd_launch ebs_test.launch
    roslaunch fsd_launch ebs_test.launch simulation:=true bag:=/path/to/bag.bag
    roslaunch fsd_launch ebs_test.launch enable_ebs_control:=true control_mode:=5
-->
<launch>
    <!-- ========== Arguments ========== -->
    <arg name="simulation" default="false" doc="仿真模式"/>
    <arg name="bag" default="" doc="Rosbag 路径（仿真模式必填）"/>
    <arg name="rate" default="1.0" doc="回放速率"/>
    <arg name="loop" default="false" doc="rosbag 是否循环播放"/>
    <arg name="launch_rviz" default="true" doc="启动 RViz"/>
    <arg name="launch_viz" default="true" doc="启动可视化节点"/>
    <arg name="rviz_mode" default="dual" doc="RViz模式: main|global|pointcloud|dual"/>
    <arg name="vehicle" default="A13" doc="车辆型谱ID"/>
    <arg name="fleet_config" default="$(find fsd_launch)/config/vehicle_fleet.yaml" doc="车辆型谱清单"/>
    <arg name="perception_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/perception.yaml"/>
    <arg name="perception_vehicle_local_config" default=""/>
    <arg name="localization_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/localization.yaml"/>
    <arg name="localization_vehicle_local_config" default=""/>
    <arg name="control_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/control.yaml"/>
    <arg name="control_vehicle_local_config" default=""/>
    <arg name="ebs_perception_config" default="$(find fsd_launch)/config/missions/ebs/perception.yaml" doc="EBS任务感知overlay"/>
    <arg name="ebs_localization_config" default="$(find fsd_launch)/config/missions/ebs/localization.yaml" doc="EBS任务定位overlay"/>
    <arg name="ebs_control_config" default="$(find fsd_launch)/config/missions/ebs/control.yaml" doc="EBS任务控制overlay"/>
    <arg name="enable_ebs_control" default="false" doc="是否启动控制节点（EBS 接口预留）"/>
    <arg name="control_mode" default="5" doc="EBS 预留控制模式ID"/>

    <!-- ========== Simulation Time ========== -->
    <param name="/use_sim_time" value="$(arg simulation)"/>
    <rosparam command="load" file="$(arg fleet_config)" ns="vehicle_fleet"/>

    <!-- ========== Subsystems ========== -->
    <!-- EBS测试阶段：沿用track参数，后续可拆分为独立 ebs 参数overlay -->
    <include file="$(find fsd_launch)/launch/subsystems/perception.launch">
        <arg name="launch_rviz" value="false"/>
        <arg name="mode" value="track"/>
        <arg name="mission_config" value="$(arg ebs_perception_config)"/>
        <arg name="vehicle" value="$(arg vehicle)"/>
        <arg name="vehicle_config" value="$(arg perception_vehicle_config)"/>
        <arg name="vehicle_local_config" value="$(arg perception_vehicle_local_config)"/>
    </include>

    <include file="$(find fsd_launch)/launch/subsystems/localization.launch">
        <arg name="mode" value="track"/>
        <arg name="mission_config" value="$(arg ebs_localization_config)"/>
        <arg name="vehicle" value="$(arg vehicle)"/>
        <arg name="vehicle_config" value="$(arg localization_vehicle_config)"/>
        <arg name="vehicle_local_config" value="$(arg localization_vehicle_local_config)"/>
    </include>

    <include file="$(find fsd_launch)/launch/subsystems/planning.launch">
        <arg name="planner" value="none"/>
    </include>

    <group if="$(arg enable_ebs_control)">
        <include file="$(find fsd_launch)/launch/subsystems/control.launch">
            <arg name="mode" value="track"/>
            <arg name="control_mode" value="$(arg control_mode)"/>
            <arg name="mission_config" value="$(arg ebs_control_config)"/>
            <arg name="vehicle" value="$(arg vehicle)"/>
            <arg name="vehicle_config" value="$(arg control_vehicle_config)"/>
            <arg name="vehicle_local_config" value="$(arg control_vehicle_local_config)"/>
        </include>

        <!-- Vehicle Interface (非仿真模式) -->
        <include unless="$(arg simulation)" file="$(find fsd_launch)/launch/subsystems/vehicle.launch"/>
    </group>

    <!-- ========== Tools ========== -->
    <!-- Rosbag Player (仿真模式) -->
    <include if="$(arg simulation)" file="$(find fsd_launch)/launch/tools/rosbag_play.launch">
        <arg name="bag" value="$(arg bag)"/>
        <arg name="rate" value="$(arg rate)"/>
        <arg name="loop" value="$(arg loop)"/>
    </include>

    <!-- FSD Visualization Node -->
    <include if="$(arg launch_viz)" file="$(find fsd_visualization)/launch/visualization.launch">
        <arg name="frame_id" value="world"/>
        <arg name="show_trail" value="true"/>
    </include>

    <!-- RViz -->
    <include if="$(arg launch_rviz)" file="$(find fsd_launch)/launch/tools/rviz.launch">
        <arg name="config" value="high_speed"/>
        <arg name="enable_viz_node" value="false"/>
        <arg name="mode" value="$(arg rviz_mode)"/>
    </include>
</launch>
