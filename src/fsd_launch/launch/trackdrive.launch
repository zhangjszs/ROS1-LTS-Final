<!--
  FSD TrackDrive Mission - 高速循迹
  
  用法:
    roslaunch fsd_launch trackdrive.launch
    roslaunch fsd_launch trackdrive.launch simulation:=true bag:=/path/to/bag.bag
-->
<launch>
    <!-- ========== Arguments ========== -->
    <arg name="simulation" default="false" doc="仿真模式"/>
    <arg name="bag" default="" doc="Rosbag 路径（仿真模式必填）"/>
    <arg name="rate" default="1.0" doc="回放速率"/>
    <arg name="loop" default="false" doc="rosbag 是否循环播放"/>
    <arg name="launch_rviz" default="true" doc="启动 RViz"/>
    <arg name="launch_viz" default="true" doc="启动可视化节点"/>
    <arg name="rviz_mode" default="main" doc="RViz模式: main(综合), global(全局), pointcloud(点云), dual(双窗口)"/>
    <arg name="publish_base_to_velodyne_tf" default="true" doc="发布 base_link->velodyne 静态TF"/>
    <arg name="velodyne_x" default="0.0" doc="velodyne 相对 base_link 的 x"/>
    <arg name="velodyne_y" default="0.0" doc="velodyne 相对 base_link 的 y"/>
    <arg name="velodyne_z" default="0.0" doc="velodyne 相对 base_link 的 z"/>
    <arg name="velodyne_roll" default="0.0" doc="velodyne 相对 base_link 的 roll"/>
    <arg name="velodyne_pitch" default="0.0" doc="velodyne 相对 base_link 的 pitch"/>
    <arg name="velodyne_yaw" default="0.0" doc="velodyne 相对 base_link 的 yaw"/>

    <!-- ========== Simulation Time ========== -->
    <param name="/use_sim_time" value="$(arg simulation)"/>

    <!-- ========== 参数校验 ========== -->
    <!-- 仿真模式必须指定bag路径 -->
    <group if="$(arg simulation)">
        <group unless="$(eval bag != '')">
            <node pkg="rospy" type="message" name="error_check" output="screen" args="错误：仿真模式必须指定bag文件路径！使用参数 bag:=/path/to/bag.bag"/>
        </group>
    </group>

    <!-- ========== Subsystems ========== -->
    <include file="$(find fsd_launch)/launch/subsystems/perception.launch">
        <arg name="launch_rviz" value="false"/>
        <arg name="mode" value="track"/>
    </include>

    <include file="$(find fsd_launch)/launch/subsystems/localization.launch">
        <arg name="mode" value="track"/>
    </include>

    <include file="$(find fsd_launch)/launch/subsystems/planning.launch">
        <arg name="planner" value="high_speed"/>
    </include>

    <include file="$(find fsd_launch)/launch/subsystems/control.launch">
        <arg name="mode" value="track"/>
    </include>

    <!-- Vehicle Interface (非仿真模式) -->
    <include unless="$(arg simulation)" file="$(find fsd_launch)/launch/subsystems/vehicle.launch"/>

    <!-- ========== Tools ========== -->
    <!-- Static TF: base_link -> velodyne -->
    <node if="$(arg publish_base_to_velodyne_tf)"
          pkg="tf2_ros"
          type="static_transform_publisher"
          name="base_link_to_velodyne"
          args="$(arg velodyne_x) $(arg velodyne_y) $(arg velodyne_z) $(arg velodyne_roll) $(arg velodyne_pitch) $(arg velodyne_yaw) base_link velodyne"/>

    <!-- Rosbag Player (仿真模式) -->
    <include if="$(arg simulation)" file="$(find fsd_launch)/launch/tools/rosbag_play.launch">
        <arg name="bag" value="$(arg bag)"/>
        <arg name="rate" value="$(arg rate)"/>
        <arg name="loop" value="$(arg loop)"/>
    </include>

    <!-- FSD Visualization Node -->
    <include if="$(arg launch_viz)" file="$(find fsd_visualization)/launch/visualization.launch">
        <arg name="frame_id" value="world"/>
        <arg name="show_trail" value="true"/>
        <arg name="use_mesh" value="false"/>
    </include>

    <!-- RViz -->
    <include if="$(arg launch_rviz)" file="$(find fsd_launch)/launch/tools/rviz.launch">
        <arg name="config" value="high_speed"/>
        <arg name="enable_viz_node" value="false"/>
        <arg name="mode" value="$(arg rviz_mode)"/>
    </include>
</launch>
