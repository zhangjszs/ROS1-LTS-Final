<launch>
    <!--
    Debug Launch for Perception + Localization + Visualization
    用于联合调试感知和定位模块，走统一的子系统参数加载链路。
    -->

    <arg name="simulation" default="false" doc="Whether to play rosbag"/>
    <arg name="bag" default="" doc="Path to rosbag file"/>
    <arg name="rviz_mode" default="world" doc="RViz mode: world|ego|dual|none"/>
    <arg name="mode" default="track" doc="赛道模式: accel | skidpad | track"/>
    <arg name="use_eskf" default="false" doc="定位侧是否启用ESKF"/>

    <arg name="vehicle" default="A13" doc="车辆型谱ID"/>
    <arg name="fleet_config" default="$(find fsd_launch)/config/vehicle_fleet.yaml"/>
    <arg name="perception_mission_config" default="" doc="感知任务overlay，可传EBS任务文件"/>
    <arg name="localization_mission_config" default="" doc="定位任务overlay，可传EBS任务文件"/>
    <arg name="perception_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/perception.yaml"/>
    <arg name="perception_vehicle_local_config" default=""/>
    <arg name="localization_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/localization.yaml"/>
    <arg name="localization_vehicle_local_config" default=""/>

    <!-- Lidar Topic Configuration -->
    <arg name="lidar_topic" default="/velodyne_points" doc="Input point cloud topic name"/>

    <!-- Set use_sim_time true if simulation is enabled -->
    <param name="/use_sim_time" value="$(arg simulation)"/>
    <rosparam command="load" file="$(arg fleet_config)" ns="vehicle_fleet"/>

    <!-- 1. Data Source (Rosbag) -->
    <!--
         注意：rosbag_play.launch 内部会启动 ins_bridge 节点，
         它将 /INS/ASENSING_INS 转换为 /pbox_pub/Ins
    -->
    <include if="$(arg simulation)" file="$(find fsd_launch)/launch/tools/rosbag_play.launch">
        <arg name="bag" value="$(arg bag)"/>
    </include>

    <!-- 2. Perception (统一子系统入口) -->
    <include file="$(find fsd_launch)/launch/subsystems/perception.launch">
        <arg name="launch_rviz" value="false"/>
        <arg name="input_topic" value="$(arg lidar_topic)"/>
        <arg name="mode" value="$(arg mode)"/>
        <arg name="mission_config" value="$(arg perception_mission_config)"/>
        <arg name="vehicle" value="$(arg vehicle)"/>
        <arg name="vehicle_config" value="$(arg perception_vehicle_config)"/>
        <arg name="vehicle_local_config" value="$(arg perception_vehicle_local_config)"/>
    </include>

    <!-- 3. Localization (统一子系统入口) -->
    <include file="$(find fsd_launch)/launch/subsystems/localization.launch">
        <arg name="use_eskf" value="$(arg use_eskf)"/>
        <arg name="mode" value="$(arg mode)"/>
        <arg name="mission_config" value="$(arg localization_mission_config)"/>
        <arg name="vehicle" value="$(arg vehicle)"/>
        <arg name="vehicle_config" value="$(arg localization_vehicle_config)"/>
        <arg name="vehicle_local_config" value="$(arg localization_vehicle_local_config)"/>
    </include>

    <!-- 4. Visualization -->
    <include file="$(find fsd_visualization)/launch/visualization.launch">
        <arg name="frame_id" value="world"/>
        <arg name="enable_cones" value="true"/>
        <arg name="enable_vehicle" value="true"/>
        <arg name="show_trail" value="true"/>
    </include>

    <!-- 5. Static TF: base_link -> velodyne -->
    <node pkg="tf2_ros" type="static_transform_publisher" name="base_link_to_velodyne" args="0 0 0 0 0 0 base_link velodyne"/>

    <!-- 6. RViz -->
    <group if="$(eval arg('rviz_mode') == 'world')">
        <node pkg="rviz" type="rviz" name="debug_rviz" args="-d $(find fsd_visualization)/rviz/world_planning.rviz"/>
    </group>

    <group if="$(eval arg('rviz_mode') == 'ego')">
        <node pkg="rviz" type="rviz" name="debug_rviz" args="-d $(find fsd_visualization)/rviz/ego_perception.rviz"/>
    </group>

    <group if="$(eval arg('rviz_mode') == 'dual')">
        <node pkg="rviz" type="rviz" name="ego_rviz" args="-d $(find fsd_visualization)/rviz/ego_perception.rviz"/>
        <node pkg="rviz" type="rviz" name="world_rviz" args="-d $(find fsd_visualization)/rviz/world_planning.rviz"/>
    </group>

</launch>
