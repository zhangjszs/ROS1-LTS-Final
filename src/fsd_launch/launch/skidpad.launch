<!--
  FSD Skidpad Mission - 八字绕环
  
  用法:
    roslaunch fsd_launch skidpad.launch
    roslaunch fsd_launch skidpad.launch simulation:=true bag:=/path/to/bag.bag
-->
<launch>
    <!-- ========== Arguments ========== -->
    <arg name="simulation" default="false" doc="仿真模式"/>
    <arg name="bag" default="" doc="Rosbag 路径（仿真模式必填）"/>
    <arg name="rate" default="1.0" doc="回放速率"/>
    <arg name="launch_rviz" default="true" doc="启动 RViz"/>
    <arg name="launch_viz" default="true" doc="启动可视化节点"/>
    <arg name="rviz_mode" default="dual" doc="RViz模式: global(全局), pointcloud(点云), dual(双窗口)"/>
    <arg name="vehicle" default="A13" doc="车辆型谱ID"/>
    <arg name="fleet_config" default="$(find fsd_launch)/config/vehicle_fleet.yaml" doc="车辆型谱清单"/>
    <arg name="perception_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/perception.yaml"/>
    <arg name="perception_vehicle_local_config" default=""/>
    <arg name="localization_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/localization.yaml"/>
    <arg name="localization_vehicle_local_config" default=""/>
    <arg name="control_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/control.yaml"/>
    <arg name="control_vehicle_local_config" default=""/>
    <arg name="cmd_topic" default="vehicle/cmd" doc="统一控制命令话题（Control输出/Vehicle消费）"/>
    <arg name="carstate_topic" default="localization/car_state" doc="统一车辆状态话题（Localization输出/Planning+Control输入）"/>
    <arg name="pathlimits_topic" default="planning/pathlimits" doc="统一路径话题（Planning输出/Control输入）"/>
    <arg name="approaching_goal_topic" default="planning/skidpad/approaching_goal" doc="统一八字接近终点话题（Planning输出/Control输入）"/>
    <arg name="publish_legacy_cmd_topic" default="false" doc="兼容开关：控制层是否同时发布 legacy cmd 话题"/>
    <arg name="subscribe_legacy_topics" default="false" doc="兼容开关：控制层是否同时订阅 legacy 输入话题"/>
    <arg name="subscribe_legacy_cmd_topic" default="false" doc="兼容开关：车辆接口是否订阅 legacy cmd 话题"/>
    <arg name="legacy_cmd_topic" default="vehcileCMDMsg" doc="legacy 控制命令话题"/>
    <arg name="legacy_carstate_topic" default="/Carstate" doc="legacy 车辆状态话题"/>
    <arg name="legacy_approaching_goal_topic" default="/skidpad_detection_node/approaching_goal" doc="legacy 接近终点话题"/>

    <!-- ========== Simulation Time ========== -->
    <param name="/use_sim_time" value="$(arg simulation)"/>
    <rosparam command="load" file="$(arg fleet_config)" ns="vehicle_fleet"/>

    <!-- ========== Subsystems ========== -->
    <include file="$(find fsd_launch)/launch/subsystems/mission_stack.launch">
        <arg name="simulation" value="$(arg simulation)"/>
        <arg name="perception_mode" value="skidpad"/>
        <arg name="localization_mode" value="skidpad"/>
        <arg name="planner" value="unified"/>
        <arg name="planning_mission" value="skidpad"/>
        <arg name="control_mode_profile" value="skidpad"/>
        <arg name="control_mode" value="3"/>
        <arg name="enable_control" value="true"/>
        <arg name="vehicle" value="$(arg vehicle)"/>
        <arg name="perception_vehicle_config" value="$(arg perception_vehicle_config)"/>
        <arg name="perception_vehicle_local_config" value="$(arg perception_vehicle_local_config)"/>
        <arg name="localization_vehicle_config" value="$(arg localization_vehicle_config)"/>
        <arg name="localization_vehicle_local_config" value="$(arg localization_vehicle_local_config)"/>
        <arg name="control_vehicle_config" value="$(arg control_vehicle_config)"/>
        <arg name="control_vehicle_local_config" value="$(arg control_vehicle_local_config)"/>
        <arg name="cmd_topic" value="$(arg cmd_topic)"/>
        <arg name="carstate_topic" value="$(arg carstate_topic)"/>
        <arg name="pathlimits_topic" value="$(arg pathlimits_topic)"/>
        <arg name="approaching_goal_topic" value="$(arg approaching_goal_topic)"/>
        <arg name="publish_legacy_cmd_topic" value="$(arg publish_legacy_cmd_topic)"/>
        <arg name="subscribe_legacy_topics" value="$(arg subscribe_legacy_topics)"/>
        <arg name="subscribe_legacy_cmd_topic" value="$(arg subscribe_legacy_cmd_topic)"/>
        <arg name="legacy_cmd_topic" value="$(arg legacy_cmd_topic)"/>
        <arg name="legacy_carstate_topic" value="$(arg legacy_carstate_topic)"/>
        <arg name="legacy_approaching_goal_topic" value="$(arg legacy_approaching_goal_topic)"/>
    </include>

    <!-- ========== Tools ========== -->
    <!-- Rosbag Player (仿真模式) -->
    <include if="$(arg simulation)" file="$(find fsd_launch)/launch/tools/rosbag_play.launch">
        <arg name="bag" value="$(arg bag)"/>
        <arg name="rate" value="$(arg rate)"/>
    </include>

    <!-- FSD Visualization Node -->
    <include if="$(arg launch_viz)" file="$(find fsd_visualization)/launch/visualization.launch">
        <arg name="frame_id" value="world"/>
        <arg name="show_trail" value="true"/>
    </include>

    <!-- RViz -->
    <include if="$(arg launch_rviz)" file="$(find fsd_launch)/launch/tools/rviz.launch">
        <arg name="config" value="skidpad"/>
        <arg name="enable_viz_node" value="false"/>
        <arg name="mode" value="$(arg rviz_mode)"/>
    </include>
</launch>
