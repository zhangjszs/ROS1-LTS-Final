<!--
  FSD Control Subsystem
  控制子系统：路径跟踪、车辆控制
-->
<launch>
    <arg name="mode" default="track" doc="赛道模式: accel | skidpad | track"/>
    <arg name="control_mode" default="-1" doc="控制算法模式ID；-1表示沿用旧逻辑"/>
    <arg name="skip_param_load" default="true" doc="是否跳过controler.launch内部参数加载"/>
    <arg name="control_base_config" default="$(find control_ros)/config/param.yaml"/>
    <arg name="control_mode_config" default="$(find control_ros)/config/control_$(arg mode).yaml"/>
    <arg name="mission_config" default="" doc="任务级参数覆盖文件（mission overlay）"/>
    <arg name="vehicle" default="A13" doc="车辆型谱ID"/>
    <arg name="vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/control.yaml"/>
    <arg name="vehicle_local_config" default="" doc="本地覆盖参数文件（*.local.yaml）"/>
    <arg name="enable_file_mode_fallback" default="false" doc="控制模式文件回退开关（兼容链路）"/>
    <arg name="mode_file_path" default="$(env HOME)/autoStartGkj/command" doc="控制模式文件路径（兼容链路）"/>
    <arg name="enable_external_stop_file" default="false" doc="文件外部停车开关（兼容链路）"/>
    <arg name="external_stop_file_path" default="$(env HOME)/autoStartGkj/command" doc="文件外部停车路径（兼容链路）"/>
    <arg name="carstate_topic" default="localization/car_state" doc="控制输入车体状态话题"/>
    <arg name="approaching_goal_topic" default="planning/skidpad/approaching_goal" doc="控制输入八字接近终点话题"/>
    <arg name="cmd_topic" default="vehicle/cmd" doc="控制输出命令话题"/>
    <arg name="diagnostics_rate_hz" default="1.0" doc="control/diagnostics 发布频率"/>
    <arg name="diagnostics_topic" default="control/diagnostics" doc="控制入口诊断本地话题"/>
    <arg name="publish_global_diagnostics" default="true" doc="是否发布到统一 /diagnostics"/>
    <arg name="global_diagnostics_topic" default="/diagnostics" doc="统一诊断总线话题"/>
    <arg name="enable_diagnostic_aggregator" default="true" doc="是否启用 diagnostic_aggregator 分组"/>
    <arg name="diagnostic_aggregator_config" default="$(find fsd_launch)/config/diagnostic_aggregator.yaml" doc="diagnostic_aggregator 配置文件"/>

    <!-- Unified PathLimits topic -->
    <arg name="pathlimits_topic" default="planning/pathlimits" doc="控制层 PathLimits 输入话题"/>

    <!-- 控制参数加载顺序：base -> mode -> mission -> vehicle -> vehicle.local -->
    <rosparam command="load" file="$(arg control_base_config)"/>
    <rosparam command="load" file="$(arg control_mode_config)"/>
    <rosparam if="$(eval arg('mission_config') != '')" command="load" file="$(arg mission_config)"/>
    <rosparam command="load" file="$(arg vehicle_config)"/>
    <rosparam if="$(eval arg('vehicle_local_config') != '')" command="load" file="$(arg vehicle_local_config)"/>
    <!-- Controller -->
    <include file="$(find control_ros)/launch/controler.launch">
        <arg name="mode_profile" value="$(arg mode)"/>
        <arg name="control_mode" value="$(arg control_mode)"/>
        <arg name="skip_param_load" value="$(arg skip_param_load)"/>
        <arg name="pathlimits_topic" value="$(arg pathlimits_topic)"/>
        <arg name="carstate_topic" value="$(arg carstate_topic)"/>
        <arg name="approaching_goal_topic" value="$(arg approaching_goal_topic)"/>
        <arg name="cmd_topic" value="$(arg cmd_topic)"/>
        <arg name="enable_file_mode_fallback" value="$(arg enable_file_mode_fallback)"/>
        <arg name="mode_file_path" value="$(arg mode_file_path)"/>
        <arg name="enable_external_stop_file" value="$(arg enable_external_stop_file)"/>
        <arg name="external_stop_file_path" value="$(arg external_stop_file_path)"/>
        <arg name="diagnostics_rate_hz" value="$(arg diagnostics_rate_hz)"/>
        <arg name="diagnostics_topic" value="$(arg diagnostics_topic)"/>
        <arg name="publish_global_diagnostics" value="$(arg publish_global_diagnostics)"/>
        <arg name="global_diagnostics_topic" value="$(arg global_diagnostics_topic)"/>
    </include>

    <node if="$(arg enable_diagnostic_aggregator)"
          pkg="diagnostic_aggregator"
          type="aggregator_node"
          name="diagnostic_aggregator"
          output="screen"
          clear_params="true">
        <rosparam command="load" file="$(arg diagnostic_aggregator_config)"/>
    </node>
</launch>
