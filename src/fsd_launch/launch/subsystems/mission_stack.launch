<!--
  Mission stack composition for standard real/sim missions.
  This launch centralizes subsystem wiring and tools to reduce cross-file duplication.
-->
<launch>
    <arg name="simulation" default="false"/>

    <arg name="perception_mode" default="track"/>
    <arg name="localization_mode" default="track"/>
    <arg name="planner" default="unified"/>
    <arg name="planning_mission" default="high_speed"/>
    <arg name="control_mode_profile" default="track"/>
    <arg name="control_mode" default="4"/>
    <arg name="enable_perception" default="true"/>
    <arg name="enable_localization" default="true"/>
    <arg name="enable_planning" default="true"/>
    <arg name="enable_control" default="true"/>

    <arg name="vehicle" default="A13"/>
    <arg name="perception_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/perception.yaml"/>
    <arg name="perception_vehicle_local_config" default=""/>
    <arg name="localization_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/localization.yaml"/>
    <arg name="localization_vehicle_local_config" default=""/>
    <arg name="control_vehicle_config" default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/control.yaml"/>
    <arg name="control_vehicle_local_config" default=""/>

    <arg name="perception_mission_config" default=""/>
    <arg name="localization_mission_config" default=""/>
    <arg name="control_mission_config" default=""/>

    <arg name="cmd_topic" default="vehicle/cmd"/>
    <arg name="carstate_topic" default="localization/car_state"/>
    <arg name="pathlimits_topic" default="planning/pathlimits"/>
    <arg name="approaching_goal_topic" default="planning/skidpad/approaching_goal"/>

    <arg name="publish_legacy_cmd_topic" default="false"/>
    <arg name="subscribe_legacy_topics" default="false"/>
    <arg name="subscribe_legacy_cmd_topic" default="false"/>
    <arg name="legacy_cmd_topic" default="vehcileCMDMsg"/>
    <arg name="legacy_carstate_topic" default="/Carstate"/>
    <arg name="legacy_approaching_goal_topic" default="/skidpad_detection_node/approaching_goal"/>

    <!-- ========== Tools args ========== -->
    <arg name="bag" default=""/>
    <arg name="rate" default="1.0"/>
    <arg name="loop" default="false"/>
    <arg name="launch_rviz" default="true"/>
    <arg name="launch_viz" default="true"/>
    <arg name="rviz_mode" default="dual"/>
    <arg name="rviz_config" default="high_speed"/>
    <arg name="fleet_config" default="$(find fsd_launch)/config/vehicle_fleet.yaml"/>
    <arg name="enable_static_tf" default="true"/>

    <!-- ========== Global Config ========== -->
    <param name="/use_sim_time" value="$(arg simulation)"/>
    <rosparam command="load" file="$(arg fleet_config)" ns="vehicle_fleet"/>

    <!-- Vehicle geometry: 统一真值源，在子系统之前加载 -->
    <arg name="vehicle_geometry_config"
         default="$(find fsd_launch)/config/vehicles/$(arg vehicle)/vehicle_geometry.yaml"/>
    <rosparam command="load" file="$(arg vehicle_geometry_config)"/>

    <!-- ========== Simulation bag validation ========== -->
    <group if="$(arg simulation)">
        <group unless="$(eval bag != '')">
            <node pkg="rospy" type="message" name="error_check" output="screen"
                  args="错误：仿真模式必须指定bag文件路径！使用参数 bag:=/path/to/bag.bag"/>
        </group>
    </group>

    <!-- ========== Subsystems ========== -->
    <include if="$(arg enable_perception)" file="$(find fsd_launch)/launch/subsystems/perception.launch">
        <arg name="launch_rviz" value="false"/>
        <arg name="mode" value="$(arg perception_mode)"/>
        <arg name="carstate_topic" value="$(arg carstate_topic)"/>
        <arg name="mission_config" value="$(arg perception_mission_config)"/>
        <arg name="vehicle" value="$(arg vehicle)"/>
        <arg name="vehicle_config" value="$(arg perception_vehicle_config)"/>
        <arg name="vehicle_local_config" value="$(arg perception_vehicle_local_config)"/>
    </include>

    <include if="$(arg enable_localization)" file="$(find fsd_launch)/launch/subsystems/localization.launch">
        <arg name="mode" value="$(arg localization_mode)"/>
        <arg name="carstate_topic" value="$(arg carstate_topic)"/>
        <arg name="mission_config" value="$(arg localization_mission_config)"/>
        <arg name="vehicle" value="$(arg vehicle)"/>
        <arg name="vehicle_config" value="$(arg localization_vehicle_config)"/>
        <arg name="vehicle_local_config" value="$(arg localization_vehicle_local_config)"/>
    </include>

    <include if="$(arg enable_planning)" file="$(find fsd_launch)/launch/subsystems/planning.launch">
        <arg name="planner" value="$(arg planner)"/>
        <arg name="mission" value="$(arg planning_mission)"/>
        <arg name="output_pathlimits_topic" value="$(arg pathlimits_topic)"/>
        <arg name="input_car_state_topic" value="$(arg carstate_topic)"/>
        <arg name="output_approaching_goal_topic" value="$(arg approaching_goal_topic)"/>
    </include>

    <group if="$(arg enable_control)">
        <include file="$(find fsd_launch)/launch/subsystems/control.launch">
            <arg name="mode" value="$(arg control_mode_profile)"/>
            <arg name="control_mode" value="$(arg control_mode)"/>
            <arg name="cmd_topic" value="$(arg cmd_topic)"/>
            <arg name="pathlimits_topic" value="$(arg pathlimits_topic)"/>
            <arg name="carstate_topic" value="$(arg carstate_topic)"/>
            <arg name="approaching_goal_topic" value="$(arg approaching_goal_topic)"/>
            <arg name="publish_legacy_cmd_topic" value="$(arg publish_legacy_cmd_topic)"/>
            <arg name="legacy_cmd_topic" value="$(arg legacy_cmd_topic)"/>
            <arg name="subscribe_legacy_topics" value="$(arg subscribe_legacy_topics)"/>
            <arg name="legacy_carstate_topic" value="$(arg legacy_carstate_topic)"/>
            <arg name="legacy_approaching_goal_topic" value="$(arg legacy_approaching_goal_topic)"/>
            <arg name="mission_config" value="$(arg control_mission_config)"/>
            <arg name="vehicle" value="$(arg vehicle)"/>
            <arg name="vehicle_config" value="$(arg control_vehicle_config)"/>
            <arg name="vehicle_local_config" value="$(arg control_vehicle_local_config)"/>
        </include>

        <include unless="$(arg simulation)" file="$(find fsd_launch)/launch/subsystems/vehicle.launch">
            <arg name="cmd_topic" value="$(arg cmd_topic)"/>
            <arg name="subscribe_legacy_cmd_topic" value="$(arg subscribe_legacy_cmd_topic)"/>
            <arg name="legacy_cmd_topic" value="$(arg legacy_cmd_topic)"/>
        </include>
    </group>
    <!-- ========== Tools ========== -->
    <!-- Rosbag Player (仿真模式) -->
    <include if="$(arg simulation)" file="$(find fsd_launch)/launch/tools/rosbag_play.launch">
        <arg name="bag" value="$(arg bag)"/>
        <arg name="rate" value="$(arg rate)"/>
        <arg name="loop" value="$(arg loop)"/>
    </include>

    <!-- Static TF: base_link -> velodyne -->
    <node if="$(arg enable_static_tf)" pkg="tf2_ros" type="static_transform_publisher"
          name="base_link_to_velodyne" args="0 0 0 0 0 0 base_link velodyne"/>

    <!-- FSD Visualization Node -->
    <include if="$(arg launch_viz)" file="$(find fsd_visualization)/launch/visualization.launch">
        <arg name="frame_id" value="world"/>
        <arg name="show_trail" value="true"/>
        <arg name="use_mesh" value="false"/>
    </include>

    <!-- RViz -->
    <include if="$(arg launch_rviz)" file="$(find fsd_launch)/launch/tools/rviz.launch">
        <arg name="config" value="$(arg rviz_config)"/>
        <arg name="enable_viz_node" value="false"/>
        <arg name="mode" value="$(arg rviz_mode)"/>
    </include>
</launch>
