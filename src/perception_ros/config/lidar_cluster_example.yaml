# ==========================
# ROS Wrapper (perception_ros)
# ==========================
# topic naming (relative, namespaced by launch)
topics:
  input: points/raw            # 输入点云话题（相对命名空间）
  points:
    passthrough: points/passthrough  # 直通滤波输出点云
    no_ground: points/no_ground      # 去地面点云
    cones: points/cones              # 锥桶点云
  detections: detections             # 锥桶检测结果
  markers:
    cones: markers/cones             # 锥桶 marker
    all: markers/all                 # 所有聚类 marker

# ==========================
# Ground Segmentation (perception_core)
# ==========================
# 传感器安装高度（单位 m），会影响地面分割的初始高度过滤
sensor_height: 0.12       # 0.18   0.135        这里存在的意义是把低于这个-sensor_height的点都先剔除掉  0.12
# 地面分割方法：ransac 简单稳定；patchworkpp 更精细但耗时更高
ground_method: ransac     # ransac | patchworkpp  地面分割方法

# --- RANSAC (ground_segmentation_ransac.cpp) ---
ransac:
  num_iter: 15              # 增加迭代次数提高精度
  num_lpr: 10               # 增加种子点数量
  th_seeds: 0.04            # 种子阈值，适中
  th_dist: 0.05             # 地面判定阈值：0.05 是平衡值
                            # 太大(>0.08): 锥桶被当地面过滤
                            # 太小(<0.03): 远处地面被误判为障碍物

# --- Patchwork++ (patchworkpp.cpp) ---
patchworkpp:
  enable_rnr: true                   # 启用 RNR（反射率法），可提升反射率区域的地面区分
  enable_rvpf: true                  # 启用 RVPF（垂直平面滤波），用于去除竖直面噪声
  enable_tgr: true                   # 启用 TGR（地面修正），提升地面估计稳定性
  num_iter: 3                        # 迭代次数，越大越稳但耗时增加
  num_lpr: 20                        # LPR 种子点数量，影响地面初始拟合
  num_min_pts: 10                    # 最小点数阈值，过小会引入噪声
  num_zones: 4                       # 分区数量，影响分区自适应
  num_rings_of_interest: 4           # 感兴趣环数，通常与雷达层数相关
  rnr_ver_angle_thr: -15.0           # RNR 垂直角阈值
  rnr_intensity_thr: 0.2             # RNR 强度阈值
  th_seeds: 0.125                    # 种子阈值，增大更保守
  th_dist: 0.125                     # 距离阈值，增大更宽松
  th_seeds_v: 0.25                   # 垂直方向种子阈值
  th_dist_v: 0.1                     # 垂直方向距离阈值
  max_range: 80.0                    # 最大处理距离（m）
  min_range: 2.7                     # 最小处理距离（m）
  uprightness_thr: 0.707             # 直立性阈值，接近 1 越严格
  adaptive_seed_selection_margin: -1.2  # 自适应种子边界
  num_sectors_each_zone: [16, 32, 54, 32]  # 各分区扇区数（由近及远）
  num_rings_each_zone: [2, 4, 4, 4]        # 各分区环数（由近及远）
  max_flatness_storage: 1000         # 平坦度缓存上限
  max_elevation_storage: 1000        # 高度缓存上限
  elevation_thr: [0, 0, 0, 0]        # 高度阈值数组（每分区）
  flatness_thr: [0, 0, 0, 0]         # 平坦度阈值数组（每分区）

# ==========================
# ROI 裁剪 & 预处理滤波
# ==========================
roi:
  mode: custom              # skidpad | accel | track | custom  ROI 模式
  use_point_clip: false    # 仅 skidpad 时有效（true=使用历史 point_clip）
  z_min: -0.2              # ROI 最低高度，低于该高度的点会被裁剪
  z_max: 1.0               # ROI 最高高度，高于该高度的点会被裁剪
  skidpad:
    x_min: 0               # skidpad x 最小值
    x_max: 50              # skidpad x 最大值
    y_min: -4             # skidpad y 最小值
    y_max: 4               # skidpad y 最大值
  accel:
    x_min: 0               # accel x 最小值
    x_max: 100             # accel x 最大值
    y_min: -4              # accel y 最小值
    y_max: 4               # accel y 最大值
  track:
    x_min: 0               # track x 最小值
    x_max: 50              # track x 最大值
    y_min: -4              # track y 最小值
    y_max: 4               # track y 最大值
  custom:
    x_min: 0               # custom x 最小值
    x_max: 20              # custom x 最大值
    y_min: -5              # custom y 最小值
    y_max: 5               # custom y 最大值

filters:
  sor:
    enable: false           # SOR 开关（统计离群点剔除）
    mean_k: 50             # 邻域点数，越大越平滑
    stddev_mul: 1.0        # 标准差倍数阈值，越小越严格
  voxel:
    enable: false          # 体素滤波开关（均匀降采样）
    leaf_size: 0.05        # 体素大小（m），越大点越稀疏
  adaptive_voxel:
    enable:  true           # 自适应体素开关（密度相关）
    leaf_size: 0.1         # 基础体素大小
    density_thr: 8         # 密度阈值：体素内点数>此值时降采样为质心，≤此值时保留原始点

# ==========================
# Cone Cluster & Confidence (perception_core)
# ==========================
# 以下都为开区间
# skidpad mode ignores this

# cone height limits (legacy, kept for backward compatibility)
min_height: 0.01           # 锥桶高度下限
max_height: 0.5           # 锥桶高度上限
# area size limits (legacy)
min_area: 0.01            # 面积下限
max_area: 0.5           # 面积上限
# bbox limits (legacy)
max_box_altitude: 0.5      # bbox 最低点高度上限

# New multi-feature confidence scoring
confidence:
  # Size constraints (放宽尺寸限制)
  min_height: 0.1          # 锥桶最小高度 (m) - 降低
  max_height: 0.8          # 锥桶最大高度 (m) - 提高
  min_area: 0.005          # 最小底面积 (m²) - 降低
  max_area: 0.25           # 最大底面积 (m²) - 提高
  max_box_altitude: 0.8    # bbox最低点最大高度 (m) - 提高

  # Shape constraints (放宽形状要求)
  min_aspect_ratio: 0.8    # 最小纵横比 - 大幅降低
  min_verticality: 0.5     # 最小垂直度 - 降低

  # Density constraints (大幅放宽密度要求)
  min_density_near: 15.0   # 近距离最小点密度 - 降低
  min_density_far: 5.0     # 远距离最小点密度 - 降低
  distance_threshold: 5.0  # 近远距离分界 (m)

  # Intensity constraints (放宽强度要求)
  min_intensity_mean: 10.0 # 最小平均强度 - 大幅降低

  # Feature weights (降低严格特征权重)
  weight_size: 0.4         # 尺寸特征权重 - 提高
  weight_shape: 0.15       # 形状特征权重 - 降低
  weight_density: 0.15     # 密度特征权重 - 降低
  weight_intensity: 0.1    # 强度特征权重 - 降低
  weight_position: 0.2     # 位置特征权重 - 提高

  # Model fitting (Phase 2) - 暂时禁用以提高召回率
  enable_model_fitting: false  # 禁用几何模型拟合
  model_fit_bonus: 0.15        # 拟合成功奖励 - 降低
  model_fit_penalty: 0.05      # 拟合失败惩罚 - 大幅降低

# ==========================
# PassThrough settings / Other params
# ==========================
vis: 0                     # 可视化选项（包括：euc 和 bbox），0 关闭

# ==========================
# Sensor Model (perception_core)
# ==========================
sensor_model: 32           # velodyne product type（16/32），影响聚类模型选择

# vlp16
# str_range: "5,10,15,20"
# str_seg_distance: "0.18,0.35,0.53,0.6,0.6"

# vlp32
str_range: "5,10,15,20"                  # 分段距离阈值（m），由近到远
str_seg_distance: "0.15,0.3,0.5,0.6,0.6" # 各分段聚类距离阈值（m），与 str_range 对应
length:
  circle2lidar: 15.0        # 圆心到雷达距离（用于赛道参数）

# ==========================
# IMU \u0026 Distortion Compensation (NEW)
# ==========================
# IMU 数据订阅和点云畸变补偿配置

imu:
  # --- IMU Topic Subscription ---
  enable: true              # IMU 功能总开关（true=启用 IMU 订阅和畸变补偿）
  topic: /pbox_pub/Ins       # IMU 数据话题（默认为 ins_bridge 发布的话题）
  buffer_size: 200           # IMU 数据缓冲区大小（保存最近 N 条消息）
  
  # --- Distortion Compensation ---
  distortion:
    enable: true            # 畸变补偿开关（独立于 IMU 订阅，可先订阅但不补偿）
    scan_period: 0.1         # 激光扫描周期（秒），Velodyne 10Hz=0.1s, 20Hz=0.05s
    
    # 补偿模式选择
    mode: velocity_only      # velocity_only | full_6dof (当前仅实现 velocity_only)
                             # velocity_only: 仅使用速度补偿平移畸变
                             # full_6dof: 速度+角速度补偿平移和旋转畸变（未来实现）
    
    # 坐标系配置
    coordinate:
      use_ned_to_frd: true   # 是否启用 NED→FRD 坐标系转换（true=启用）
                             # NED (北东地) → FRD (前右下)，符合车体坐标系
    
    # 滤波和插值
    interpolation:
      enable: true           # 启用 IMU 时间同步插值（与点云时间戳对齐）
      max_time_diff: 0.2     # 最大允许时间差（秒），超过则丢弃该点云
    
    # 调试和验证
    debug:
      enable: false          # 调试模式（输出补偿前后的点云对比）
      publish_raw: false     # 发布原始未补偿点云到 /points/raw_undistorted
      publish_compensated: false  # 发布补偿后点云到 /points/compensated
      log_imu_data: false    # 打印 IMU 数据到 console（用于验证数据正确性）
      log_compensation: false # 打印每帧补偿信息（速度、角速度等）

  # --- IMU Sensor Parameters (未来扩展) ---
  # 以下参数用于未来的高级畸变补偿和 IMU 预积分
  sensor:
    # IMU 到 LiDAR 的外参（暂未使用，预留）
    extrinsics:
      enable: false          # 是否使用外参
      tx: 0.0                # X 方向平移（m）
      ty: 0.0                # Y 方向平移（m）
      tz: 0.0                # Z 方向平移（m）
      roll: 0.0              # Roll 旋转（度）
      pitch: 0.0             # Pitch 旋转（度）
      yaw: 0.0               # Yaw 旋转（度）
    
    # IMU 噪声模型（用于卡尔曼滤波等高级应用）
    noise:
      gyro_noise: 0.01       # 陀螺仪噪声标准差（rad/s）
      accel_noise: 0.1       # 加速度计噪声标准差（m/s²）
      gyro_bias: 0.001       # 陀螺仪偏置漂移（rad/s）
      accel_bias: 0.01       # 加速度计偏置漂移（m/s²）

# ==========================
# 配置说明
# ==========================
# 
# IMU 畸变补偿功能使用指南：
#
# 1. 基础启用（仅订阅 IMU，不补偿）
#    imu.enable: true
#    imu.distortion.enable: false
#    用途：验证 IMU 数据是否正确接收
#
# 2. 启用畸变补偿（推荐用于高速场景）
#    imu.enable: true
#    imu.distortion.enable: true
#    imu.distortion.scan_period: 0.1  # 根据你的雷达调整
#    用途：补偿车辆运动导致的点云畸变
#
# 3. 验证补偿效果
#    imu.debug.enable: true
#    imu.debug.publish_raw: true
#    imu.debug.publish_compensated: true
#    用途：对比补偿前后点云，评估效果
#
# 相关文件：
# - IMU 数据订阅: src/perception_ros/src/imu_subscriber.cpp
# - 畸变补偿算法: src/perception_core/src/distortion_adjust.cpp
# - IMU 数据结构: src/perception_core/include/perception_core/imu_data.hpp
# - INS 消息定义: src/autodrive_msgs/msg/HUAT_InsP2.msg

