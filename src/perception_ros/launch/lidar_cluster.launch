<launch>
    <arg name="bag" default="" />
    <arg name="launch_rviz" default="true" />
    <arg name="rviz_config" default="$(find fsd_visualization)/rviz/ego_perception.rviz" />
    <arg name="ns" default="/perception/lidar_cluster" />
    <arg name="input_topic" default="/velodyne_points" />
    <arg name="carstate_topic" default="localization/car_state" />
    <arg name="mode" default="track" doc="赛道模式: accel | skidpad | track"/>
    <arg name="mission_config" default="" doc="任务级参数覆盖文件（mission overlay）"/>
    <arg name="extra_config" default="" doc="额外参数覆盖文件（vehicle overlay）"/>
    <arg name="extra_local_config" default="" doc="额外本地覆盖文件（*.local.yaml）"/>

    <!-- B7: Removed redundant use_sim_time setting - should be managed by parent launch file -->

    <group ns="$(arg ns)">
        <node pkg="nodelet" type="nodelet" name="lidar_cluster_nodelet_manager" args="manager" output="screen" />
        <node pkg="nodelet" type="nodelet" name="lidar_cluster_node" args="load nodelet_lidar/Lidar_Cluster_Nodelet lidar_cluster_nodelet_manager" output="screen">
            <!-- 新参数体系：Base + Overlay(按任务模式) -->
            <rosparam command="load" file="$(find perception_ros)/config/lidar_base.yaml" />
            <rosparam command="load" file="$(find perception_ros)/config/lidar_$(arg mode).yaml" />
            <rosparam if="$(eval arg('mission_config') != '')" command="load" file="$(arg mission_config)" />
            <rosparam if="$(eval arg('extra_config') != '')" command="load" file="$(arg extra_config)" />
            <rosparam if="$(eval arg('extra_local_config') != '')" command="load" file="$(arg extra_local_config)" />
            <param name="topics/input" value="$(arg input_topic)" />
            <param name="topics/car_state_in" value="$(arg carstate_topic)" />
            <param name="topics/car_state_out" value="$(arg carstate_topic)" />
        </node>
    </group>

    <node if="$(arg launch_rviz)" pkg="rviz" type="rviz" name="rviz" args="-d $(arg rviz_config)" />

    <!-- Play rosbag with clock to publish /clock topic for sim time -->
    <node pkg="rosbag" type="play" name="rosbag_play" output="screen" 
          args="--clock $(arg bag)" if="$(eval arg('bag') != '')" />
</launch>
